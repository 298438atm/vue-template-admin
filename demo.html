<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const APISecret = 'MmEyMDk5MDY4NDU0MWIzNTllZDdmYmJl'
        const APIKey = '9c55c46a4c72a3360fc1112f069cafcc'
        function getWebsocketUrl() {
            return new Promise((resolve, reject) => {
                var apiKey = APIKey
                var apiSecret = APISecret
                var url = 'wss://spark-api.xf-yun.com/v1.1/chat'
                var host = 'spark-api.xf-yun.com'
                var date = new Date().toGMTString()
                var algorithm = 'hmac-sha256'
                var headers = 'host date request-line'
                var signatureOrigin = `host: ${host}\ndate: ${date}\nGET /v1.1/chat HTTP/1.1`
                var signatureSha = CryptoJS.HmacSHA256(signatureOrigin, apiSecret)
                var signature = CryptoJS.enc.Base64.stringify(signatureSha)
                var authorizationOrigin = `api_key="${apiKey}", algorithm="${algorithm}", headers="${headers}", signature="${signature}"`
                var authorization = btoa(authorizationOrigin)
                url = `${url}?authorization=${authorization}&date=${date}&host=${host}`
                resolve(url)
            })
        }
        getWebsocketUrl().then(url => {
            var ws = new WebSocket(url);
            ws.onopen = function (evt) {
                console.log("Connection open ...");
                ws.send(JSON.stringify({
                    "header": {
                        "app_id": "5802eb00",
                        "uid": "12345"
                    },
                    "parameter": {
                        "chat": {
                            "domain": "general",
                            "temperature": 0.5,
                            "max_tokens": 4096,
                        }
                    },
                    "payload": {
                        "message": {
                            "text": [
                                { "role": "user", "content": "你是谁" }
                            ]
                        }
                    }
                }))
            };

        })
    </script>
</body>

</html>